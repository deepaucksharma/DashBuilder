# NRDOT v2 Architecture Diagrams

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            NRDOT v2 Framework                               │
│                         Process Metrics Optimization                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              HOST SYSTEM                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│  │   System Procs  │  │  Application    │  │   Container     │           │
│  │  (init, sshd)   │  │    Processes    │  │   Workloads     │           │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘           │
│           │                    │                    │                      │
│           └────────────────────┴────────────────────┘                      │
│                                │                                           │
│  ┌─────────────────────────────▼─────────────────────────────────────┐    │
│  │                    NRDOT Collector (OTel)                         │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │    │
│  │  │  Receivers   │  │  Processors  │  │  Exporters   │          │    │
│  │  │              │  │              │  │              │          │    │
│  │  │ hostmetrics  │──▶│ • scoring   │──▶│ • otlphttp  │          │    │
│  │  │ prometheus   │  │ • filtering │  │ • prometheus│          │    │
│  │  └──────────────┘  │ • transform │  └──────────────┘          │    │
│  │                    │ • batching  │                             │    │
│  │                    └──────────────┘                             │    │
│  └─────────────────────────────┬─────────────────────────────────┘    │
│                                │                                        │
│  ┌─────────────────────────────▼─────────────────────────────────┐    │
│  │                    Control Loop Service                        │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │    │
│  │  │   Metrics    │  │   Decision   │  │   Config     │       │    │
│  │  │  Collection  │──▶│    Engine    │──▶│   Update     │       │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘       │    │
│  │         ▲                                      │              │    │
│  │         └──────────────────────────────────────┘              │    │
│  └───────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │   New Relic Cloud     │
                        │  • Process Metrics    │
                        │  • Cost Analytics     │
                        │  • Dashboards         │
                        └───────────────────────┘
```

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           NRDOT v2 Data Flow                                │
└─────────────────────────────────────────────────────────────────────────────┘

    Process Metrics Collection
    ┌──────────────┐
    │   Processes  │
    │  ~1000/host  │
    └──────┬───────┘
           │ 100%
           ▼
    ┌──────────────┐     ┌─────────────────┐
    │  Scraping    │────▶│ Process Scoring │
    │  60s interval│     │  (Importance)   │
    └──────────────┘     └────────┬────────┘
                                  │
                          ┌───────▼────────┐
                          │ Classification │
                          │   6 Tiers      │
                          └───────┬────────┘
                                  │
                   ┌──────────────┴──────────────┐
                   │                             │
           ┌───────▼────────┐          ┌────────▼────────┐
           │  Thresholds    │          │   Top-K Filter  │
           │   Filtering    │          │   Per Class     │
           └───────┬────────┘          └────────┬────────┘
                   │                             │
                   └──────────────┬──────────────┘
                                  │
                          ┌───────▼────────┐
                          │   Batching     │
                          │  Aggregation   │
                          └───────┬────────┘
                                  │ ~200-300 series
                                  ▼ (70-85% reduction)
                          ┌───────────────┐
                          │  New Relic    │
                          │   Endpoint    │
                          └───────────────┘

    Control Loop Feedback
    ┌──────────────┐
    │ Local Metrics│◀────────────┐
    └──────┬───────┘             │
           │                     │
    ┌──────▼───────┐     ┌───────┴────────┐
    │  Decisions   │────▶│ Profile Update │
    └──────────────┘     └────────────────┘
```

## Profile State Machine

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        NRDOT Profile State Machine                          │
└─────────────────────────────────────────────────────────────────────────────┘

                            ┌─────────────┐
                            │   START     │
                            └──────┬──────┘
                                   │
                                   ▼
                            ┌─────────────┐
                    ┌───────│Conservative │───────┐
                    │       └─────────────┘       │
                    │              ▲              │
                    │              │              │
         Series < Target      Coverage OK      Series > Max
         Cost < Budget        Cost < 80%       Cost > Budget
                    │              │              │
                    ▼              │              ▼
            ┌─────────────┐        │        ┌─────────────┐
            │  Balanced   │◀───────┴───────▶│ Aggressive  │
            └─────────────┘                 └─────────────┘
                    │                               │
                    │                               │
              Coverage < 95%                  Cost > 2x Budget
              Or Thrashing                    Or Critical Event
                    │                               │
                    └───────────┬───────────────────┘
                                │
                                ▼
                        ┌─────────────┐
                        │  Emergency  │
                        └─────────────┘

    Transition Rules:
    • Each transition has a 5-minute cooldown
    • Anti-thrashing: Max 3 changes per 5 minutes
    • Emergency overrides all other rules
    • Manual override always possible
```

## Component Interaction Sequence

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NRDOT Component Interaction                              │
└─────────────────────────────────────────────────────────────────────────────┘

Collector         Control Loop      Config File      New Relic
    │                 │                 │                │
    │                 │                 │                │
    ├──[Start]────────┤                 │                │
    │                 │                 │                │
    │                 ├──[Read Config]──▶│                │
    │                 │◀─────[State]─────┤                │
    │                 │                 │                │
    │◀──[Metrics]─────┤                 │                │
    │                 │                 │                │
    │──[Process]──────┤                 │                │
    │   Scoring       │                 │                │
    │   Filtering     │                 │                │
    │                 │                 │                │
    │─────────────────┼─────────────────┼──[Export]──────▶│
    │                 │                 │                │
    │──[Prometheus]───▶│                 │                │
    │                 │                 │                │
    │                 ├──[Analyze]──────┤                │
    │                 │  • Series Count │                │
    │                 │  • Coverage     │                │
    │                 │  • Cost         │                │
    │                 │                 │                │
    │                 ├──[Decision]─────┤                │
    │                 │                 │                │
    │                 ├──[Update]───────▶│                │
    │                 │◀──[Confirm]──────┤                │
    │                 │                 │                │
    │◀──[Reload]──────┤                 │                │
    │                 │                 │                │
    │──[Continue]─────┼─────────────────┼────────────────▶│
    │                 │                 │                │
    
    ────────────── Time (30s intervals) ──────────────▶
```

## Cost Reduction Visualization

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Cost Reduction by Profile                            │
└─────────────────────────────────────────────────────────────────────────────┘

Series Count & Cost
│
│ 10000 ┤ ████████████████████████████████ No Optimization ($2.50/hr)
│       │
│  8000 ┤
│       │
│  5000 ┤ ████████████████ Conservative (50% reduction, $1.25/hr)
│       │
│  3000 ┤ ██████████ Balanced (70% reduction, $0.75/hr)
│       │
│  1500 ┤ █████ Aggressive (85% reduction, $0.375/hr)
│       │
│   500 ┤ ██ Emergency (95% reduction, $0.125/hr)
│       │
│     0 └────────────────────────────────────────────────────
         0%    20%    40%    60%    80%    100%
                    Reduction Percentage

Coverage by Profile
│
│  100% ┤ ████████████████████████████████ Conservative
│       │ ███████████████████████████████  Balanced
│   95% ┤ █████████████████████████        Aggressive
│       │
│   90% ┤ ████████████████                 Emergency
│       │
│   85% └────────────────────────────────────────────────────
         Conservative  Balanced  Aggressive  Emergency
```